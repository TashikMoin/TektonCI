# This file will create 2 tasks and execute them from a Pipeline <-- PipelineRun CRDs.

# Tasks will be referenced inside pipeline CRD and then we will execute/invoke 
# the pipeline using PipelineRun CRD. This will create TaskRun automatically by looking at pipeline.

---
# Task # 1 (a task with just 1 step or container)
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: hello
spec:
  params:
  - name: username                       # This parameter will be passed to this Task when it is invoked/executed.
    type: string
    default: Johndoe                     # If parameter value is not passed it will use this default value.
  steps:
    - name: hello
      image: ubuntu
      script: |
        #!/bin/bash
        echo "hello $(params.username)!"  

---
# Task # 2 (a task with just 1 step or container)
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: goodbye
spec:
  params:
  - name: username                       # This parameter will be passed to this Task when it is invoked/executed.
    type: string
    default: "Foobar"                    # If parameter value is not passed it will use this default value.
  steps:
    - name: goodbye
      image: ubuntu
      script: |
        #!/bin/bash
        echo "goodbye $(params.username)!"  


---
# Pipeline to execute above tasks
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: hello-goodbye
spec:
  params:
  - name: username
    type: string
    default: Jack
  tasks:

    - name: first-task               # The name of the 1st task in the pipeline        
      taskRef:
        name: hello             # This is a reference to first task. It should match with the 1st task name we just created above using Task CRD.

    - name: second-task              # The name of the 2nd task in the pipeline
      runAfter:                     
        - first-task                 # it should match with the pipeline task name defined inside pipeline and not with the actual task name defined inside the task CRD.
      taskRef:
        name: goodbye                # This is a reference to second task. It should match with the 2nd task name we just created above using Task CRD.
      params:
      - name: username
        value: $(params.username)    # Passing value of parameter username to the 2nd task only. The value of this parameter is passed from pipeline parameters using params.<pipeline parameter here> syntax


---
# PipelineRun to execute above Pipeline
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: hello-goodbye-pipeline-run
spec:
  pipelineRef:                       # reference to pipeline we created above.
    name: hello-goodbye
  params:
  - name: username                   # passing parameter to the pipeline when pipeline is invoked/executed.
    value: "Tekton"                


# to see logs of the pipeline
# kubectl logs $(kubectl get pods -o name | grep <name of the pipeline task pod here>)