apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerBinding
metadata:
  name: build-test-deploy-pipeline-tb
spec:
  params:
  - name: url
    value: $(body.url)
  - name: revision
    value: $(body.revision)
  - name: build
    value: $(body.build)
    
# to see complete payload data of github PR, visit, 
# https://docs.github.com/en/webhooks-and-events/webhooks/webhook-events-and-payloads#pullrequestevent
# https://github.com/gogs/gogs/issues/1573


---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: build-test-deploy-pipeline-tt
spec:

  params:
  - name: url
    description: The repository url to build and deploy.
  - name: revision
    description: The revision or sha of the commit.
  - name: build
    description: build number

  resourcetemplates:
  - apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      generateName: "build-test-deploy-pipeline-pipelinerun"
      labels:
        pipelineRunName: "build-test-deploy-pipeline-pipelinerun-$(tt.params.build)"
    spec:
      serviceAccountName: build-test-deploy-pipeline-sa
      params:
      - name: repo-url
        value: "$(tt.params.url)"
      - name: builder-image
        value: "$(tt.params.builderImage)"
      - name: context
        value: "$(tt.params.context)"
      - name: dockerfile
        value: "$(tt.params.dockerfile)"
      - name: image
        value: "$(tt.params.image)"
      pipelineRef:
        name: "$(tt.params.pipelineName)"
      podTemplate:
        securityContext:
          fsGroup: 65532
          
      workspaces:
      - name: pipeline-secrets
        secret:
          secretName: pipeline-secrets
      - name: shared-data
        volumeClaimTemplate:
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
